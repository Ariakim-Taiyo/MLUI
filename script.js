let livObj,vehObj,currentEncodedScript,cLiv,isValidClient=!0,favorites=[];async function fetchLiv(){await fetch("https://raw.githubusercontent.com/Spice9/Geofs-Multiliveries/main/dependencies/liveries.json").then((e=>e.json())).then((e=>livObj=e)).then((function(){populateLiveries("")}))}async function fetchVeh(){await fetch("https://raw.githubusercontent.com/Spice9/Geofs-Multiliveries/main/dependencies/frames.json").then((e=>e.json())).then((e=>vehObj=e)).then((function(){populateVehicles("")}))}function getAverageRGB(e){var t,n,i,a,o={r:0,g:0,b:0},r=document.createElement("canvas"),s=r.getContext&&r.getContext("2d"),l=-4,c={r:0,g:0,b:0},d=0;if(!s)return o;i=r.height=e.naturalHeight||e.offsetHeight||e.height,n=r.width=e.naturalWidth||e.offsetWidth||e.width,s.drawImage(e,0,0);try{t=s.getImageData(0,0,n,i)}catch(e){return o}for(a=t.data.length;(l+=60)<a;)++d,c.r+=t.data[l],c.g+=t.data[l+1],c.b+=t.data[l+2];return c.r=~~(c.r/d),c.g=~~(c.g/d),c.b=~~(c.b/d),c}function createMessage(e,t){var n=document.getElementById("messageContainer"),i=document.createElement("div");n.children.length>3&&n.children[0].remove(),i.className="message",i.innerText=e,n.appendChild(i),setTimeout((function(){var e=1,t=setInterval((function(){(e-=.01)<=0&&(clearInterval(t),i.remove()),i.style.opacity=e,i.style.height=e.toString()+"rem"}),10)}),t)}function createLiveryButton(e,t){var n=document.getElementById("liveryGallery"),i=document.createElement("div"),a=document.createElement("div"),o=document.createElement("div"),r=document.createElement("span"),s=e.name;s=s.split(" (")[0]+"\n("+s.split("(")[1],i.className="selectionItem",void 0!==e.thumb&&(e.thumb.includes("png")||e.thumb.includes("jpg"))?a.innerHTML="<img crossorigin='anonymous' src="+e.thumb+" alt="+s+" onerror='this.onerror=null;this.src=`"+e.mptx+"`;'>":a.innerHTML="<img crossorigin='anonymous' src='https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg' alt="+s+">",a.setAttribute("draggable",!1),i.onmouseover=function(){var e=getAverageRGB(i.children[0].children[0]);fullsizePreview(i.children[0].children[0].src),document.getElementsByClassName("previewDisplay")[0].style.filter="drop-shadow(0 0 1.75rem rgb("+e.r+", "+e.g+", "+e.b+")"},o.className="favoriteStar",o.id="star_"+e.name,o.innerHTML='<span style="color:yellow;">☆</span>',o.onclick=function(){pushFavorite(e)},o.onmouseover=function(){'<span style="color:yellow;">☆</span>'===o.innerHTML&&(o.innerHTML='<span temp="true" style="color:yellow;">★</span>')},o.onmouseleave=function(){'<span temp="true" style="color:yellow;">★</span>'===o.innerHTML&&(o.innerHTML='<span style="color:yellow;">☆</span>')},i.appendChild(a),r.innerText=s,i.appendChild(r),i.appendChild(o),i.addEventListener("click",(function(){isValidClient?window.opener.postMessage({type:"livery",custom:!1,livery:t},"*"):createMessage("Invalid client, please use the original code.",5e3)})),n.appendChild(i)}function createVehicleButton(e){var t=document.getElementById("vehicleGallery"),n=document.createElement("div");n.className="selectionItem",n.innerText=e.name,n.style.backgroundColor=getComputedStyle(document.body).getPropertyValue("--bg-secondary"),n.style.width="100%",n.style.height="1rem",n.addEventListener("click",(function(){isValidClient?window.opener.postMessage({type:"vehicle",definition:e.definition},"*"):createMessage("Invalid client, please use the original code.",5e3)})),t.appendChild(n)}function populateLiveries(e){document.getElementById("liveryGallery").innerHTML="";var t=0;livObj.aircraft.forEach((function(n){t++,n.name.toLowerCase().includes(e.toLowerCase())&&createLiveryButton(n,t)}))}function populateVehicles(e){document.getElementById("vehicleGallery").innerHTML="",vehObj.frames.forEach((function(t){var n=atob(t.definition);if(["userrecord","document.","window.","location.","navigator.","screen.","history","performance","postMessage","XMLHttpRequest","fetch","WebSocket","eval(","alert(","confirm(","prompt(","localstorage","sessionstorage","indexeddb","openDatabase","webkitStorageInfo","webkitIndexedDB","$("].some((e=>n.includes(e))))return createMessage("Vehicle '"+t.name+"' may contain malicious code.",5e3),void createMessage("Vehicle '"+t.name+"' blocked automatically by client",5e3);t.name.toLowerCase().includes(e.toLowerCase())&&createVehicleButton(t)}))}function fullsizePreview(e){var t=document.getElementById("fullsizeImage");t.src=e,t.setAttribute("draggable",!1)}function assignFavorites(){document.getElementById("liveryGallery").children.length>=livObj.aircraft.length&&livObj.aircraft.forEach((function(e){document.getElementById("star_"+e.name).innerHTML='<span style="color:yellow;">☆</span>'})),favorites.forEach((function(e){document.getElementById("star_"+e).innerHTML='<span style="color:yellow;">★</span>'}))}function toggleFavorites(){var e=document.getElementById("searchByFav");"☆"===e.innerHTML?(e.innerHTML="★",document.getElementById("liveryGallery").innerHTML="",livObj.aircraft.forEach((function(e){favorites.includes(e.name)&&createLiveryButton(e)}))):(e.innerHTML="☆",populateLiveries(""));assignFavorites()}function pushFavorite(e){var t=document.getElementById("star_"+e.name);t.innerHTML.includes('temp="true"')?(favorites.push(e.name),t.innerHTML='<span style="color:yellow;">★</span>',createMessage("Added Favorite",1e3)):(favorites.splice(favorites.indexOf(e.name),1),t.innerHTML='<span style="color:yellow;">☆</span>',"★"===document.getElementById("searchByFav").innerHTML&&t.parentNode.remove(),createMessage("Removed Favorite",1e3)),window.opener.postMessage({type:"favorites",favorites:favorites},"*")}function applyCustomLivery(){if(isValidClient){var e=document.getElementById("customLiveryIn").files[0],t=new FileReader;t.onload=function(e){cLiv=e.target.result,window.opener.postMessage({type:"livery",custom:!0,livery:cLiv},"*")},t.readAsDataURL(e)}else createMessage("Invalid client, please use the original code.",5e3)}function updateWatermarkOffset(){var e=document.getElementById("offsetRange").value;window.opener.postMessage({type:"offset",offset:e,livery:cLiv},"*")}fetchLiv(),fetchVeh();let lastOffset=0,offsetInterval=setInterval((function(){document.URL.includes("custom")&&document.getElementById("offsetRange").value!=lastOffset&&(updateWatermarkOffset(),lastOffset=document.getElementById("offsetRange").value)}),250);async function getCurrentEncodedScript(){var e="";await fetch("https://raw.githubusercontent.com/Spice9/Geofs-Multiliveries/main/Multiliveries.js").then((e=>e.text())).then((t=>e=t));var t=e.match(/async function multiliveries\(\) \{([^]*)\}/)[0];currentEncodedScript=t.replaceAll("\r","")}function checkIntegrity(){window.opener.postMessage({type:"test"},"*")}getCurrentEncodedScript();var integrityInt=setInterval((function(){checkIntegrity()}),2e3);function toggleSubmissionForm(){var e=document.getElementById("formBlur"),t=document.getElementById("formModal");"flex"!==e.style.display?(e.style.display="flex",t.style.display="flex"):(e.style.display="none",t.style.display="none")}async function doSubmission(){var e=document.getElementById("nameInput").value,t=document.getElementById("authorInput").value,n=document.getElementById("airframeInput").value,i=document.getElementById("thumbInput").value,a=document.getElementById("subLivInput").value;if(""===e||""===t||""===n||""===a)return toggleSubmissionForm(),void createMessage("Missing Submission Information.",2500);if(!a.includes(".png")&&!a.includes(".jpg"))return toggleSubmissionForm(),void createMessage("Livery Must be a png or jpg file link.",2500);if(!a.includes("https"))return toggleSubmissionForm(),void createMessage("Livery Must be a HTTPS link.",2500);var o="```json\n"+JSON.stringify({name:n+"("+e+") by "+t,livery:a,mptx:a,thumb:i},null,4)+"```";submissionInput=`New Livery Submission from ${t}: \n ${e} for ${n} \n Proposed Livery Object: \n${o}`,fetch("https://discord.com/api/webhooks/1233643589184258160/wZIYaogmR3t5RSPBT1SZm_iWyADjdNpW9UmB0pWdRjcPyeZoZ4JcS1zY3zy00NKZOPYk",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:"Multiliveries",avatar_url:"https://private-user-images.githubusercontent.com/79466778/324317750-1f2c2d53-957f-4d0d-add4-197c49905ffd.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQxOTc5NjcsIm5iZiI6MTcxNDE5NzY2NywicGF0aCI6Ii83OTQ2Njc3OC8zMjQzMTc3NTAtMWYyYzJkNTMtOTU3Zi00ZDBkLWFkZDQtMTk3YzQ5OTA1ZmZkLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjclMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI3VDA2MDEwN1omWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWQ3YjM4NGI4ZDNmMmRhMDkxOWE3NDRjNTg0MTFlNzJkYWVjMDg1N2I3MjNmYTdmZDA1ZDc0Yzk3Y2NjZmZlMzEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.Omm3QUxAVro10f0UTyGQPszr4WUNhO4Z894cxT0uM9Y",content:submissionInput,allowed_mentions:{parse:["users","roles"]}})}),toggleSubmissionForm(),createMessage('Submitted Livery,"'+e+'"',2500)}window.addEventListener("message",(e=>{"favorites"===(e=e.data).type&&(favorites=e.favorites,assignFavorites()),"answer"===e.type&&(e.payload===currentEncodedScript?isValidClient=!0:(isValidClient=!1,window.opener.postMessage({type:"invalid"},"*")))}));
