let livObj,vehObj,cLiv,isValidClient=!0,favorites=[],currentEncodedScript=getCurrentEncodedScript();async function fetchLiv(){await fetch("https://raw.githubusercontent.com/Spice9/Geofs-Multiliveries/main/dependencies/liveries.json").then((e=>e.json())).then((e=>livObj=e)).then((function(){populateLiveries("")}))}async function fetchVeh(){await fetch("https://raw.githubusercontent.com/Spice9/Geofs-Multiliveries/main/dependencies/frames.json").then((e=>e.json())).then((e=>vehObj=e)).then((function(){populateVehicles("")}))}function getAverageRGB(e){var t,n,i,a,o={r:0,g:0,b:0},r=document.createElement("canvas"),s=r.getContext&&r.getContext("2d"),l=-4,c={r:0,g:0,b:0},d=0;if(!s)return o;i=r.height=e.naturalHeight||e.offsetHeight||e.height,n=r.width=e.naturalWidth||e.offsetWidth||e.width,s.drawImage(e,0,0);try{t=s.getImageData(0,0,n,i)}catch(e){return o}for(a=t.data.length;(l+=60)<a;)++d,c.r+=t.data[l],c.g+=t.data[l+1],c.b+=t.data[l+2];return c.r=~~(c.r/d),c.g=~~(c.g/d),c.b=~~(c.b/d),c}function createMessage(e,t){var n=document.getElementById("messageContainer"),i=document.createElement("div");n.children.length>3&&n.children[0].remove(),i.className="message",i.innerText=e,n.appendChild(i),setTimeout((function(){var e=1,t=setInterval((function(){(e-=.01)<=0&&(clearInterval(t),i.remove()),i.style.opacity=e,i.style.height=e.toString()+"rem"}),10)}),t)}function createLiveryButton(e){var t=document.getElementById("liveryGallery"),n=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div"),o=document.createElement("span"),r=e.name;r=r.split(" (")[0]+"\n("+r.split("(")[1],n.className="selectionItem",void 0!==e.thumb&&(e.thumb.includes("png")||e.thumb.includes("jpg"))?i.innerHTML="<img crossorigin='anonymous' src="+e.thumb+" alt="+r+" onerror='this.onerror=null;this.src=`"+e.mptx+"`;'>":i.innerHTML="<img crossorigin='anonymous' src='https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg' alt="+r+">",i.setAttribute("draggable",!1),n.onmouseover=function(){var e=getAverageRGB(n.children[0].children[0]);fullsizePreview(n.children[0].children[0].src),document.getElementsByClassName("previewDisplay")[0].style.filter="drop-shadow(0 0 1.75rem rgb("+e.r+", "+e.g+", "+e.b+")"},a.className="favoriteStar",a.id="star_"+e.name,a.innerHTML='<span style="color:yellow;">☆</span>',a.onclick=function(){pushFavorite(e)},a.onmouseover=function(){'<span style="color:yellow;">☆</span>'===a.innerHTML&&(a.innerHTML='<span temp="true" style="color:yellow;">★</span>')},a.onmouseleave=function(){'<span temp="true" style="color:yellow;">★</span>'===a.innerHTML&&(a.innerHTML='<span style="color:yellow;">☆</span>')},n.appendChild(i),o.innerText=r,n.appendChild(o),n.appendChild(a),n.addEventListener("click",(function(){isValidClient?window.opener.postMessage({type:"livery",custom:!1,livery:e.livery},"*"):createMessage("Invalid client, please use the original code.",5e3)})),t.appendChild(n)}function createVehicleButton(e){var t=document.getElementById("vehicleGallery"),n=document.createElement("div");n.className="selectionItem",n.innerText=e.name,n.style.backgroundColor=getComputedStyle(document.body).getPropertyValue("--bg-secondary"),n.style.width="100%",n.style.height="1rem",n.addEventListener("click",(function(){isValidClient?(console.log(e.definition),window.opener.postMessage({type:"vehicle",definition:e.definition},"*")):createMessage("Invalid client, please use the original code.",5e3)})),t.appendChild(n)}function populateLiveries(e){document.getElementById("liveryGallery").innerHTML="",livObj.aircraft.forEach((function(t){t.name.toLowerCase().includes(e.toLowerCase())&&createLiveryButton(t)}))}function populateVehicles(e){document.getElementById("vehicleGallery").innerHTML="",vehObj.frames.forEach((function(t){var n=atob(t.definition);console.log(n);if(["userrecord","document.","window.","location.","navigator.","screen.","history","performance","postMessage","XMLHttpRequest","fetch","WebSocket","eval(","alert(","confirm(","prompt(","localstorage","sessionstorage","indexeddb","openDatabase","webkitStorageInfo","webkitIndexedDB","$("].some((e=>n.includes(e))))return createMessage("Vehicle '"+t.name+"' may contain malicious code.",5e3),void createMessage("Vehicle '"+t.name+"' blocked automatically by client",5e3);t.name.toLowerCase().includes(e.toLowerCase())&&createVehicleButton(t)}))}function fullsizePreview(e){var t=document.getElementById("fullsizeImage");t.src=e,t.setAttribute("draggable",!1)}function assignFavorites(){document.getElementById("liveryGallery").children.length>=livObj.aircraft.length&&livObj.aircraft.forEach((function(e){document.getElementById("star_"+e.name).innerHTML='<span style="color:yellow;">☆</span>'})),favorites.forEach((function(e){document.getElementById("star_"+e).innerHTML='<span style="color:yellow;">★</span>'}))}function toggleFavorites(){var e=document.getElementById("searchByFav");"☆"===e.innerHTML?(e.innerHTML="★",document.getElementById("liveryGallery").innerHTML="",livObj.aircraft.forEach((function(e){favorites.includes(e.name)&&createLiveryButton(e)}))):(e.innerHTML="☆",populateLiveries(""));assignFavorites()}function pushFavorite(e){var t=document.getElementById("star_"+e.name);t.innerHTML.includes('temp="true"')?(favorites.push(e.name),t.innerHTML='<span style="color:yellow;">★</span>',createMessage("Added Favorite",1e3)):(favorites.splice(favorites.indexOf(e.name),1),t.innerHTML='<span style="color:yellow;">☆</span>',"★"===document.getElementById("searchByFav").innerHTML&&t.parentNode.remove(),createMessage("Removed Favorite",1e3)),window.opener.postMessage({type:"favorites",favorites:favorites},"*")}function applyCustomLivery(){if(isValidClient){var e=document.getElementById("customLiveryIn").files[0],t=new FileReader;t.onload=function(e){cLiv=e.target.result,console.log(cLiv),window.opener.postMessage({type:"livery",custom:!0,livery:cLiv},"*")},t.readAsDataURL(e)}else createMessage("Invalid client, please use the original code.",5e3)}function updateWatermarkOffset(){var e=document.getElementById("offsetRange").value;console.log(e),window.opener.postMessage({type:"offset",offset:e,livery:cLiv},"*")}fetchLiv(),fetchVeh();let lastOffset=0,offsetInterval=setInterval((function(){document.URL.includes("custom")&&document.getElementById("offsetRange").value!=lastOffset&&(updateWatermarkOffset(),lastOffset=document.getElementById("offsetRange").value)}),250);async function getCurrentEncodedScript(){var e="";await fetch("https://raw.githubusercontent.com/Spice9/Geofs-Multiliveries/main/Multiliveries.js").then((e=>e.text())).then((t=>e=t));var t=e.match(/function multiliveries\(\) \{([^]*)\}/)[1];return btoa(t)}function checkIntegrity(){window.opener.postMessage({type:"test"},"*")}var integrityInt=setInterval((function(){checkIntegrity()}),2e3);window.addEventListener("message",(e=>{"favorites"===(e=e.data).type&&(favorites=e.favorites,assignFavorites()),"answer"===e.type&&(e.payload===currentEncodedScript?isValidClient=!0:(isValidClient=!1,window.opener.postMessage({type:"invalid"},"*")))}));
